@using BlazorDatasheet.Model
@inherits BaseEditorComponent

<input
    type="date"
    class="date-input"
    @bind="EditDate"
    @onclick="() => EditState.IsSoftEdit = false"
    @bind:event="oninput"
    @ref="InputRef"/>

@code {

    public override void BeginEdit(EditEntryMode entryMode, Cell cell, string key)
    {
        EditState.Cell = cell;
        EditState.CanAcceptEdit = true;
        EditState.CanCancelEdit = true;

        var canParse = DateTime.TryParse(cell.Value, out DateTime parsedDateTime);
        if (!canParse)
            EditState.EditString = DateTime.Now.ToString();
        else
            EditState.EditString = cell.Value;

        if (entryMode == EditEntryMode.Key)
        {
    // If we are typing a number, set it to the first char in the date string, (e.g first part of day or month)
            if (char.IsNumber((char)key.First()))
            {
                var newDateString = key + EditState.EditString?.Substring(1, EditState.EditString.Length - 1);
                if (DateTime.TryParse(newDateString, out var newDate))
                    EditState.EditString = newDateString;
                else
                    EditState.EditString = DateTime.Now.ToString();
            }
            else
            {
                EditState.EditString = DateTime.Now.ToString();
            }

            EditState.IsSoftEdit = true;
        }

        StateHasChanged();
    }

    private ElementReference InputRef;

    private DateTime? EditDate
    {
        set { EditState.EditString = value.ToString(); }
        get { return String.IsNullOrEmpty(EditState.EditString) ? null : DateTime.Parse(EditState.EditString); }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await InputRef.FocusAsync();
            await base.OnAfterRenderAsync(firstRender);
        }
    }

}