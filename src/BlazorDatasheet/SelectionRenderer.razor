@using System.Text
@using BlazorDatasheet.Data
@using BlazorDatasheet.Render
@using Range = BlazorDatasheet.Data.Range
@using System.ComponentModel
@using BlazorDatasheet.Selecting

<!-- Render the temp selection (currently selected range) -->
@if (TempSelection.ActiveRange != null && FixedTempSelection.Area > 0)
{
    <!-- We split into ranges around the cell's start position, so that the cell's 
    start position shows the renderer underneath it -->
    var brokenRanges = FixedTempSelection.Break(TempSelection.ActiveRange.Start);
    foreach (var range in brokenRanges)
    {
        <BoxOverlayRenderer
            BackgroundVisible="@true"
            BackgroundStyle="@bgStyle"
            BorderThickness="0"
            X="@CellLayoutProvider.ComputeLeftPosition(range)"
            Y="@CellLayoutProvider.ComputeTopPosition(range)"
            Width="@CellLayoutProvider.ComputeWidth(range)"
            Height="@CellLayoutProvider.ComputeHeight(range)"/>
    }
    <!-- now render the border around the whole thing -->
    <BoxOverlayRenderer
        BackgroundVisible="@false"
        BackgroundStyle="@bgStyle"
        BorderThickness="1"
        X="@CellLayoutProvider.ComputeLeftPosition(FixedTempSelection)"
        Y="@CellLayoutProvider.ComputeTopPosition(FixedTempSelection)"
        Width="@CellLayoutProvider.ComputeWidth(FixedTempSelection)"
        Height="@CellLayoutProvider.ComputeHeight(FixedTempSelection)"/>
}

<!-- render the selections that exist in the sheet -->
@if (Sheet?.Selection != null && !Sheet.Selection.IsEmpty())
{
    foreach (var range in Sheet.Selection.Ranges)
    {
        var fixedRange = range.GetIntersection(Sheet.Range);
        var isActiveRange = range == Sheet.Selection.ActiveRange;
        <!-- if it's the active range, render around the active position -->
        if (isActiveRange)
        {
            var brokenRanges = fixedRange.Break(Sheet.Selection.ActiveCellPosition);
            foreach (var brokenRange in brokenRanges)
            {
                <BoxOverlayRenderer
                    BackgroundStyle="@bgStyle"
                    BackgroundVisible="true"
                    BorderThickness="0"
                    X="CellLayoutProvider.ComputeLeftPosition(brokenRange)"
                    Y="CellLayoutProvider.ComputeTopPosition(brokenRange)"
                    Width="CellLayoutProvider.ComputeWidth(brokenRange)"
                    Height="CellLayoutProvider.ComputeHeight(brokenRange)"/>
            }
        }

        <!-- now render the border around the whole range. No fill on active range because we've filled it already -->
        <BoxOverlayRenderer
            BackgroundVisible="@(!isActiveRange)"
            BorderThickness="1"
            BackgroundStyle="@bgStyle"
            X="CellLayoutProvider.ComputeLeftPosition(fixedRange)"
            Y="CellLayoutProvider.ComputeTopPosition(fixedRange)"
            Width="CellLayoutProvider.ComputeWidth(fixedRange)"
            Height="CellLayoutProvider.ComputeHeight(fixedRange)"/>
    }
}

<style>

</style>

@code {

    [Parameter, EditorRequired]
    public CellLayoutProvider CellLayoutProvider { get; set; }

    private Sheet? _sheet;

    [Parameter, EditorRequired]
    public Sheet? Sheet { get; set; }

    private Selection? _tempSelection { get; set; }

    [Parameter, EditorRequired]
    // The range that is currently being selected.
    public Selection? TempSelection { get; set; }

    private string bgStyle = "background:var(--selection-bg-color);";

    private IFixedSizeRange? FixedTempSelection => TempSelection?.ActiveRange?.GetIntersection(Sheet?.Range);

    protected override void OnParametersSet()
    {
        if (_tempSelection != TempSelection)
        {
            if (_tempSelection != null)
            {
                _tempSelection.Changed -= OnSelectionChanged;
            }
            _tempSelection = TempSelection;
            _tempSelection.Changed += OnSelectionChanged;
        }

        if (_sheet != Sheet)
        {
            if (_sheet != null)
            {
                _sheet.Selection.Changed -= OnSelectionChanged;
            }
            _sheet = Sheet;
            _sheet.Selection.Changed += OnSelectionChanged;
        }
    }

    private void OnSelectionChanged(object? sender, IEnumerable<IRange> ranges)
    {
        StateHasChanged();
    }

    /*private string GetSizeStyleString(IFixedSizeRange? range, double borderThickness, bool bgVisible)
    {
        if (range == null)
            return "";

        var strBuilder = new StringBuilder();

        var left = CellLayoutProvider.ComputeLeftPosition(range);
        var top = CellLayoutProvider.ComputeTopPosition(range);
        var w = CellLayoutProvider.ComputeWidth(range);
        var h = CellLayoutProvider.ComputeHeight(range);

        strBuilder.Append($"left:{left - 1}px;");
        strBuilder.Append($"top:{top - 1}px;");
        strBuilder.Append($"width:{w + 2}px;");
        strBuilder.Append($"height:{h + 2}px;");

        if (borderThickness != 0)
        {
            strBuilder.Append($"border-width: {borderThickness}px;");
            strBuilder.Append($"border-color:var(--selection-border-color);");
            strBuilder.Append($"border-style:solid;");
        }

        if (bgVisible)
        {
            strBuilder.Append($"background:var(--selection-bg-color);");
        }


        var style = strBuilder.ToString();
        return style;
    }*/

}