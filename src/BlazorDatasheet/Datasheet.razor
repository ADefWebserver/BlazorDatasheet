@using BlazorDatasheet.Model
@using System.Text.Encodings.Web
@using BlazorDatasheet.Interfaces
@using Microsoft.JSInterop;
@inject IJSRuntime JS
@using BlazorDatasheet.Render;
@implements IDisposable;
@inject IWindowEventService _WindowEventService;

<table
    class="sheet @(IsDataSheetActive ? "active-sheet" : "inactive-sheet")"
    @onmouseover="() => IsMouseInsideSheet = true"
    @onmouseout="() => IsMouseInsideSheet = false">
    <!-- Column headers -->
    <tr>
        <td style="background: #fafafa; border: 1px solid lightgray"></td>
        @for (var i = 0; i < Sheet?.Cols; i++)
        {
            var col = i;
            var colDefn = Sheet.ColumnHeadings.Count > i ? Sheet.ColumnHeadings[i] : null;
            <th
                class="sheet-cell column-head @(IsDataSheetActive && Sheet.IsColumnActive(col) ? "column-active" : "")"
                @onmouseup="e => HandleCellMouseUp(-1, col, e)"
                @onmouseover="e => HandleCellMouseOver(-1, col, e)"
                @onmousedown="e => HandleColumnHeaderMouseDown(col, e)">
                @colDefn?.Header
            </th>
        }
    </tr>

    @for (var i = 0; i < Sheet?.Rows; i++)
    {
        var rowHead = i;
        var rowDefn = Sheet.RowHeadings.Count > rowHead ? Sheet.RowHeadings[rowHead] : null;
        <tr>
            <td
                class="sheet-cell row-head @(IsDataSheetActive && Sheet.IsRowActive(rowHead) ? "row-active" : "")"
                @onmousedown="e => HandleRowHeaderMouseDown(rowHead, e)"
                @onmouseover="e => HandleCellMouseOver(rowHead, -1, e)"
                @onmouseup="e => HandleCellMouseUp(rowHead, -1, e)">
                @rowDefn?.Header
            </td>
            @for (int j = 0; j < Sheet?.Cols; j++)
            {
                var row = i;
                var col = j;

                var cell = Sheet.GetCell(row, col);
                var format = Sheet.GetFormat(cell);

                <td
                    class="sheet-cell"
                    @onmousedown="e => HandleCellMouseDown(row, col, e)"
                    @onmouseover="e => HandleCellMouseOver(row, col, e)"
                    @ondblclick="e => HandleCellDoubleClick(row, col, e)"
                    @onmouseup="e => HandleCellMouseUp(row, col, e)">
                    @if (EditPosition?.Col == col && EditPosition?.Row == row)
                    {
                        @if (cell.Type == "text" || cell.Type == "number")
                        {
                            <TextEditorComponent
                                @ref="ActiveEditorReference"/>
                        }
                        else if (cell.Type == "boolean")
                        {
                            <BoolEditorComponent
                                @ref="ActiveEditorReference"/>
                        }
                        else if (cell.Type == "datetime")
                        {
                            <DateTimeEditorComponent
                                @ref="ActiveEditorReference"/>
                        }
                        else if (cell.Type == "select")
                        {
                            <SelectEditorComponent
                                @ref="ActiveEditorReference"/>
                        }
                    }
                    else
                    {
                        <div
                            class="@(IsDataSheetActive && Sheet.IsSelected(row, col) ? "cell-selected" : "") cell"
                            style="
                            background: @format.BackgroundColor; 
                            color: @format.ForegroundColor;
                            font-weight: @format.FontWeight;
                            display: flex;
                            ">
                            @if (format.Icon != null)
                            {
                                <div style="margin-right:2px; color: @format.IconColor">@format.Icon</div>
                            }
                            <DynamicComponent
                                Type="@getCellRendererType(cell.Type)"
                                Parameters="@getCellRendererParameters(cell)">
                            </DynamicComponent>
                        </div>
                    }

                </td>
            }
        </tr>
    }
</table>